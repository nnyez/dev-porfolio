rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== FUNCIONES AUXILIARES ====================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isProgrammer() {
      return isAuthenticated() && getUserRole() == 'programmer';
    }
    
    function isStandard() {
      return isAuthenticated() && getUserRole() == 'standard';
    }
    
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    
    // ==================== COLECCIÓN: USERS ====================
    match /users/{userId} {
      // LECTURA: Cualquiera puede ver perfiles públicos de desarrolladores
      allow read: if true;
      
      // CREAR: Solo propietario durante registro
      allow create: if isAuthenticated() && isOwner(userId);
      
      // ACTUALIZAR: Propietario o admin
      allow update: if isAdmin() || isOwner(userId);
      
      // ELIMINAR: Solo admin
      allow delete: if isAdmin();
    }
    
    // ==================== COLECCIÓN: PROJECTS ====================
    match /projects/{projectId} {
      // LECTURA: Cualquiera puede ver los proyectos de los desarrolladores
      allow read: if true;
      
      // CREAR: Programadores y admin crean proyectos
      allow create: if (isProgrammer() || isAdmin()) && 
                       request.resource.data.ownerUid == request.auth.uid;
      
      // ACTUALIZAR: El propietario (ownerUid) o admin
      allow update: if isAdmin() || 
                       isOwner(resource.data.ownerUid);
      
      // ELIMINAR: El propietario o admin
      allow delete: if isAdmin() || 
                       isOwner(resource.data.ownerUid);
    }
    
    // ==================== COLECCIÓN: APPLICATIONS ====================
    match /applications/{applicationId} {
      // LECTURA: Permite a usuario estándar leer sus solicitudes (crear + leer con query)
      // Permite a programador leer solicitudes que le hicieron
      // Admin ve todo
      allow read: if isAdmin() || 
                     (isStandard() && resource.data.clientUid == request.auth.uid) ||
                     (isProgrammer() && resource.data.programmerUid == request.auth.uid);
      
      // CREAR: Clientes (standard) y admin crean aplicaciones
      allow create: if (isStandard() || isAdmin()) && 
                       request.resource.data.clientUid == request.auth.uid;
      
      // ACTUALIZAR: Cliente, programador o admin
      allow update: if isAdmin() ||
                       (isStandard() && resource.data.clientUid == request.auth.uid) ||
                       (isProgrammer() && resource.data.programmerUid == request.auth.uid);
      
      // ELIMINAR: Cliente o admin
      allow delete: if isAdmin() || 
                       (isStandard() && resource.data.clientUid == request.auth.uid);
    }
    
    // ==================== COLECCIÓN: MESSAGES ====================
    match /messages/{messageId} {
      // LECTURA: Participantes o admin
      allow read: if isAdmin() || request.auth.uid in resource.data.participants;
      
      // CREAR: Usuario autenticado
      allow create: if isAuthenticated() && 
                       request.resource.data.senderId == request.auth.uid;
      
      // ACTUALIZAR: Solo el remitente
      allow update: if resource.data.senderId == request.auth.uid;
      
      // ELIMINAR: Remitente o admin
      allow delete: if isAdmin() || resource.data.senderId == request.auth.uid;
    }
    
    // ==================== COLECCIÓN: NOTIFICATIONS ====================
    match /notifications/{notificationId} {
      // LECTURA: Destinatario o admin
      allow read: if resource.data.userId == request.auth.uid || isAdmin();
      
      // CREAR: Cualquier autenticado
      allow create: if isAuthenticated();
      
      // ACTUALIZAR: Destinatario o admin
      allow update: if resource.data.userId == request.auth.uid || isAdmin();
      
      // ELIMINAR: Destinatario o admin
      allow delete: if resource.data.userId == request.auth.uid || isAdmin();
    }
    
    // ==================== COLECCIÓN: SCHEDULES ====================
    match /schedules/{userId} {
      // LECTURA: El propietario o admin
      allow read: if isOwner(userId) || isAdmin();
      
      // CREAR/ACTUALIZAR: El propietario o admin
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // ==================== POLÍTICA POR DEFECTO ====================
    // Negar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}